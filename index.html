

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tortas por Red ¬∑ v6 Responsive</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    :root {
      --bg: #ffffff;
      --text: #0b1220;
      --muted: #5b6473;
      --border: #e6e8ee;
      --card: rgba(255,255,255,0.76);
      --accent: #2563eb;
      --accent-2: #0ea5e9;
      --ring: rgba(37,99,235,.18);
      --panel: #f7f9fc;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(900px 500px at 15% -10%, #eaf2ff 0%, transparent 60%) no-repeat,
        radial-gradient(1200px 700px at 110% 10%, #e9fbff 0%, transparent 60%) no-repeat,
        #fff;
    }
    header { display:flex; align-items:center; justify-content:space-between; padding: 20px 16px 8px 16px; }
    .brand { display:flex; align-items:center; gap:12px; }
    .logo { width:32px; height:32px; border-radius:10px; background: conic-gradient(from 120deg, var(--accent), var(--accent-2)); box-shadow: 0 8px 22px rgba(37,99,235,.24);}
    h1 { margin:0; font-size:20px; letter-spacing:.2px; }
    .sub { color: var(--muted); font-size:12px; margin-top:4px; }
    .shell { padding: 0 16px 20px; }
    .controls { display:grid; gap:10px; grid-template-columns: repeat(6, 1fr); margin-bottom: 14px; }
    @media (max-width: 1024px) {
      .controls { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 640px) {
      header { flex-direction: column; align-items: flex-start; gap: 10px; }
      .controls { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--card);
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 8px 30px rgba(2,6,23,0.06);
    }
    label { display:block; font-size:12px; color:var(--muted); margin-bottom:4px; }
    select {
      width:100%; background:#fff; color:var(--text);
      border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-size:14px; outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    select:focus { border-color: var(--accent); box-shadow: 0 0 0 5px var(--ring); }
    .btn {
      user-select:none; cursor:pointer; border:1px solid var(--border); background:#fff;
      padding:10px 12px; border-radius:12px; font-size:14px;
      transition: box-shadow .15s ease, border-color .15s ease, transform .02s ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn-primary { border-color: #c7d2fe; background: linear-gradient(180deg,#ffffff,#f5f7ff); }
    .btn-primary.active { border-color: var(--accent); box-shadow: 0 0 0 5px var(--ring); }
    .row { display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width: 900px) { .row.cols-2 { grid-template-columns: 1fr 1fr; } .row.cols-3 { grid-template-columns: 1fr 1fr 1fr; } }
    .chart-wrap { position:relative; height: 340px; background:#fff; border:1px solid var(--border); border-radius:16px; padding:12px; }
    @media (max-width: 640px) {
      .chart-wrap { height: 260px; padding:10px; }
    }
    .compare-panel {
      grid-column: 1 / -1;
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
      background: var(--panel);
      border:1px dashed var(--border);
      border-radius: 14px;
      padding: 10px;
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transform: translateY(-6px);
      transition: max-height .35s ease, opacity .25s ease, transform .25s ease;
    }
    .compare-panel.open { max-height: 220px; opacity: 1; transform: translateY(0);}
    @media (max-width: 640px) {
      .compare-panel { grid-template-columns: repeat(2, 1fr); }
    }
    .hint { font-size: 12px; color: var(--muted); margin-left: 6px; }
    footer { margin-top: 14px; color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Tortas por Red ¬∑ v6 Responsive</h1>
        <div class="sub">Dise√±o adaptado a m√≥vil ¬∑ Leyenda abajo en pantallas peque√±as ¬∑ Porcentajes internos</div>
      </div>
    </div>
    <button id="compareToggle" class="btn btn-primary">üîÄ Comparar perfiles</button>
  </header>

  <div class="shell">
    <div class="card controls">
      <div>
        <label for="modo">Modo</label>
        <select id="modo">
          <option value="global">Global</option>
          <option value="perfil">Por perfil</option>
          <option value="mosaico">Mosaico</option>
        </select>
      </div>

      <div>
        <label for="red">Red</label>
        <select id="red">
          <option value="Facebook">Facebook</option>
          <option value="Instagram">Instagram</option>
        </select>
      </div>

      <div id="perfilSelectWrap" style="display:none;">
        <label for="perfil">Perfil</label>
        <select id="perfil"></select>
      </div>

      <div>
        <label for="catOrder">Ordenar perfiles por categor√≠a <span class="hint">(solo mosaico)</span></label>
        <select id="catOrder"></select>
      </div>

      <div>
        <label for="dirOrder">Orden</label>
        <select id="dirOrder">
          <option value="desc">Mayor ‚Üí menor</option>
          <option value="asc">Menor ‚Üí mayor</option>
        </select>
      </div>

      <div></div> <!-- spacer -->

      <!-- Panel de comparaci√≥n (desplegable) -->
      <div id="comparePanel" class="compare-panel">
        <div style="grid-column: 1 / -1; display:flex; align-items:center; justify-content:space-between; margin-bottom:2px;">
          <strong>Comparar perfiles</strong>
          <span class="hint">Selecciona Red/Perfil A y B</span>
        </div>
        <div>
          <label for="redA">Red A</label>
          <select id="redA">
            <option value="Facebook">Facebook</option>
            <option value="Instagram">Instagram</option>
          </select>
        </div>
        <div>
          <label for="perfilA">Perfil A</label>
          <select id="perfilA"></select>
        </div>
        <div>
          <label for="redB">Red B</label>
          <select id="redB">
            <option value="Facebook">Facebook</option>
            <option value="Instagram">Instagram</option>
          </select>
        </div>
        <div>
          <label for="perfilB">Perfil B</label>
          <select id="perfilB"></select>
        </div>
      </div>
    </div>

    <div class="card">
      <div id="canvasArea" class="row">
        <div class="chart-wrap">
          <canvas id="mainChart"></canvas>
        </div>
      </div>
    </div>

    <footer>Fuente: porcentaje_categorias_facebook_limpio.csv & porcentaje_categorias_instagram.csv</footer>
  </div>

  <script>
    const PAYLOAD = {"Facebook": {"global": {"labels": ["Sin categor√≠a", "SEGURIDAD", "INVERTIR PARA CRECER", "TRANSPARENCIA P√öBLICA"], "values": [459, 146, 99, 59]}, "perfiles": ["Alcald√≠a de Cali", "Alejandro Eder", "Casa Matria", "DAGMA", "Departamento Administrativo de Contrataci√≥n P√∫blica de Cali", "Departamento Administrativo de Control Disciplinario Interno de Instrucci√≥n", "Departamento Administrativo de Desarrollo e Innovaci√≥n Institucional", "Departamento Administrativo de Hacienda de Cali", "Departamento Administrativo de Planeaci√≥n Municipal", "Empresa de Desarrollo y Renovaci√≥n Urbana", "Petronio √Ålvarez", "Secretar√≠a de Bienestar Social", "Secretar√≠a de Cultura de Cali", "Secretar√≠a de Desarrollo Econ√≥mico", "Secretar√≠a de Desarrollo Territorial y Participaci√≥n Ciudadana", "Secretar√≠a de Educaci√≥n de Cali", "Secretar√≠a de Gobierno", "Secretar√≠a de Infraestructura", "Secretar√≠a de Movilidad de Cali", "Secretar√≠a de Paz y Cultura Ciudadana", "Secretar√≠a de Salud P√∫blica", "Secretar√≠a de Seguridad y Justicia de Cali", "Secretar√≠a de Turismo", "Secretar√≠a de Vivienda Social y H√°bitat", "Secretar√≠a del Deporte y la Recreaci√≥n", "Secretar√≠a para la Gesti√≥n del Riesgo de Emergencias y Desastres", "Tecnolog√≠as de la Informaci√≥n y las Comunicaciones de Cali", "Unidad Administrativa Especial de Gesti√≥n de Bienes y Servicios de Cali", "Unidad Administrativa Especial de Protecci√≥n Animal Cali", "Unidad Administrativa Especial de Servicios P√∫blicos Municipales Uaespm", "Yawa"], "data_por_perfil": {"Alcald√≠a de Cali": {"labels": ["Sin categor√≠a", "SEGURIDAD", "INVERTIR PARA CRECER", "TRANSPARENCIA P√öBLICA"], "values": [40, 15, 10, 1]}, "Alejandro Eder": {"labels": ["Sin categor√≠a", "SEGURIDAD", "INVERTIR PARA CRECER", "TRANSPARENCIA P√öBLICA"], "values": [22, 9, 5, 1]}, "Casa Matria": {"labels": ["Sin categor√≠a", "INVERTIR PARA CRECER"], "values": [4, 1]}, "DAGMA": {"labels": ["Sin categor√≠a", "INVERTIR PARA CRECER"], "values": [13, 1]}, "Departamento Administrativo de Contrataci√≥n P√∫blica de Cali": {"labels": ["TRANSPARENCIA P√öBLICA", "Sin categor√≠a", "SEGURIDAD"], "values": [19, 2, 1]}, "Departamento Administrativo de Control Disciplinario Interno de Instrucci√≥n": {"labels": ["Sin categor√≠a", "TRANSPARENCIA P√öBLICA"], "values": [1, 1]}, "Departamento Administrativo de Desarrollo e Innovaci√≥n Institucional": {"labels": ["Sin categor√≠a", "TRANSPARENCIA P√öBLICA"], "values": [2, 1]}, "Departamento Administrativo de Hacienda de Cali": {"labels": ["Sin categor√≠a", "TRANSPARENCIA P√öBLICA"], "values": [2, 2]}, "Departamento Administrativo de Planeaci√≥n Municipal": {"labels": ["Sin categor√≠a", "TRANSPARENCIA P√öBLICA", "SEGURIDAD"], "values": [9, 2, 1]}, "Empresa de Desarrollo y Renovaci√≥n Urbana": {"labels": ["INVERTIR PARA CRECER", "Sin categor√≠a", "TRANSPARENCIA P√öBLICA"], "values": [2, 2, 1]}, "Petronio √Ålvarez": {"labels": ["Sin categor√≠a"], "values": [15]}, "Secretar√≠a de Bienestar Social": {"labels": ["Sin categor√≠a", "SEGURIDAD", "INVERTIR PARA CRECER", "TRANSPARENCIA P√öBLICA"], "values": [39, 3, 1, 1]}, "Secretar√≠a de Cultura de Cali": {"labels": ["Sin categor√≠a", "INVERTIR PARA CRECER", "TRANSPARENCIA P√öBLICA"], "values": [18, 2, 1]}, "Secretar√≠a de Desarrollo Econ√≥mico": {"labels": ["Sin categor√≠a", "INVERTIR PARA CRECER", "TRANSPARENCIA P√öBLICA"], "values": [13, 12, 2]}, "Secretar√≠a de Desarrollo Territorial y Participaci√≥n Ciudadana": {"labels": ["Sin categor√≠a", "TRANSPARENCIA P√öBLICA", "INVERTIR PARA CRECER", "SEGURIDAD"], "values": [22, 6, 4, 1]}, "Secretar√≠a de Educaci√≥n de Cali": {"labels": ["Sin categor√≠a", "INVERTIR PARA CRECER", "TRANSPARENCIA P√öBLICA"], "values": [25, 14, 3]}, "Secretar√≠a de Gobierno": {"labels": ["Sin categor√≠a", "TRANSPARENCIA P√öBLICA", "INVERTIR PARA CRECER", "SEGURIDAD"], "values": [4, 4, 3, 2]}, "Secretar√≠a de Infraestructura": {"labels": ["INVERTIR PARA CRECER", "TRANSPARENCIA P√öBLICA", "SEGURIDAD", "Sin categor√≠a"], "values": [19, 2, 1, 1]}, "Secretar√≠a de Movilidad de Cali": {"labels": ["SEGURIDAD", "Sin categor√≠a", "INVERTIR PARA CRECER"], "values": [44, 6, 1]}, "Secretar√≠a de Paz y Cultura Ciudadana": {"labels": ["SEGURIDAD", "Sin categor√≠a", "TRANSPARENCIA P√öBLICA"], "values": [12, 7, 2]}, "Secretar√≠a de Salud P√∫blica": {"labels": ["Sin categor√≠a", "SEGURIDAD", "TRANSPARENCIA P√öBLICA"], "values": [22, 4, 1]}, "Secretar√≠a de Seguridad y Justicia de Cali": {"labels": ["SEGURIDAD", "INVERTIR PARA CRECER", "Sin categor√≠a", "TRANSPARENCIA P√öBLICA"], "values": [34, 2, 1, 1]}, "Secretar√≠a de Turismo": {"labels": ["Sin categor√≠a", "SEGURIDAD"], "values": [32, 1]}, "Secretar√≠a de Vivienda Social y H√°bitat": {"labels": ["INVERTIR PARA CRECER", "Sin categor√≠a", "SEGURIDAD", "TRANSPARENCIA P√öBLICA"], "values": [7, 2, 1, 1]}, "Secretar√≠a del Deporte y la Recreaci√≥n": {"labels": ["Sin categor√≠a", "INVERTIR PARA CRECER"], "values": [109, 1]}, "Secretar√≠a para la Gesti√≥n del Riesgo de Emergencias y Desastres": {"labels": ["SEGURIDAD", "INVERTIR PARA CRECER", "Sin categor√≠a", "TRANSPARENCIA P√öBLICA"], "values": [7, 4, 2, 2]}, "Tecnolog√≠as de la Informaci√≥n y las Comunicaciones de Cali": {"labels": ["INVERTIR PARA CRECER", "Sin categor√≠a", "TRANSPARENCIA P√öBLICA"], "values": [4, 4, 1]}, "Unidad Administrativa Especial de Gesti√≥n de Bienes y Servicios de Cali": {"labels": ["Sin categor√≠a", "TRANSPARENCIA P√öBLICA", "INVERTIR PARA CRECER", "SEGURIDAD"], "values": [8, 4, 3, 3]}, "Unidad Administrativa Especial de Protecci√≥n Animal Cali": {"labels": ["Sin categor√≠a", "SEGURIDAD"], "values": [10, 2]}, "Unidad Administrativa Especial de Servicios P√∫blicos Municipales Uaespm": {"labels": ["Sin categor√≠a", "SEGURIDAD", "INVERTIR PARA CRECER"], "values": [18, 5, 3]}, "Yawa": {"labels": ["Sin categor√≠a"], "values": [4]}}, "profile_cat_table": {"Alcald√≠a de Cali": {"Sin categor√≠a": 40, "SEGURIDAD": 15, "INVERTIR PARA CRECER": 10, "TRANSPARENCIA P√öBLICA": 1}, "Alejandro Eder": {"Sin categor√≠a": 22, "SEGURIDAD": 9, "INVERTIR PARA CRECER": 5, "TRANSPARENCIA P√öBLICA": 1}, "Casa Matria": {"Sin categor√≠a": 4, "INVERTIR PARA CRECER": 1}, "DAGMA": {"Sin categor√≠a": 13, "INVERTIR PARA CRECER": 1}, "Departamento Administrativo de Contrataci√≥n P√∫blica de Cali": {"TRANSPARENCIA P√öBLICA": 19, "Sin categor√≠a": 2, "SEGURIDAD": 1}, "Departamento Administrativo de Control Disciplinario Interno de Instrucci√≥n": {"Sin categor√≠a": 1, "TRANSPARENCIA P√öBLICA": 1}, "Departamento Administrativo de Desarrollo e Innovaci√≥n Institucional": {"Sin categor√≠a": 2, "TRANSPARENCIA P√öBLICA": 1}, "Departamento Administrativo de Hacienda de Cali": {"Sin categor√≠a": 2, "TRANSPARENCIA P√öBLICA": 2}, "Departamento Administrativo de Planeaci√≥n Municipal": {"Sin categor√≠a": 9, "TRANSPARENCIA P√öBLICA": 2, "SEGURIDAD": 1}, "Empresa de Desarrollo y Renovaci√≥n Urbana": {"INVERTIR PARA CRECER": 2, "Sin categor√≠a": 2, "TRANSPARENCIA P√öBLICA": 1}, "Petronio √Ålvarez": {"Sin categor√≠a": 15}, "Secretar√≠a de Bienestar Social": {"Sin categor√≠a": 39, "SEGURIDAD": 3, "INVERTIR PARA CRECER": 1, "TRANSPARENCIA P√öBLICA": 1}, "Secretar√≠a de Cultura de Cali": {"Sin categor√≠a": 18, "INVERTIR PARA CRECER": 2, "TRANSPARENCIA P√öBLICA": 1}, "Secretar√≠a de Desarrollo Econ√≥mico": {"Sin categor√≠a": 13, "INVERTIR PARA CRECER": 12, "TRANSPARENCIA P√öBLICA": 2}, "Secretar√≠a de Desarrollo Territorial y Participaci√≥n Ciudadana": {"Sin categor√≠a": 22, "TRANSPARENCIA P√öBLICA": 6, "INVERTIR PARA CRECER": 4, "SEGURIDAD": 1}, "Secretar√≠a de Educaci√≥n de Cali": {"Sin categor√≠a": 25, "INVERTIR PARA CRECER": 14, "TRANSPARENCIA P√öBLICA": 3}, "Secretar√≠a de Gobierno": {"Sin categor√≠a": 4, "TRANSPARENCIA P√öBLICA": 4, "INVERTIR PARA CRECER": 3, "SEGURIDAD": 2}, "Secretar√≠a de Infraestructura": {"INVERTIR PARA CRECER": 19, "TRANSPARENCIA P√öBLICA": 2, "SEGURIDAD": 1, "Sin categor√≠a": 1}, "Secretar√≠a de Movilidad de Cali": {"SEGURIDAD": 44, "Sin categor√≠a": 6, "INVERTIR PARA CRECER": 1}, "Secretar√≠a de Paz y Cultura Ciudadana": {"SEGURIDAD": 12, "Sin categor√≠a": 7, "TRANSPARENCIA P√öBLICA": 2}, "Secretar√≠a de Salud P√∫blica": {"Sin categor√≠a": 22, "SEGURIDAD": 4, "TRANSPARENCIA P√öBLICA": 1}, "Secretar√≠a de Seguridad y Justicia de Cali": {"SEGURIDAD": 34, "INVERTIR PARA CRECER": 2, "Sin categor√≠a": 1, "TRANSPARENCIA P√öBLICA": 1}, "Secretar√≠a de Turismo": {"Sin categor√≠a": 32, "SEGURIDAD": 1}, "Secretar√≠a de Vivienda Social y H√°bitat": {"INVERTIR PARA CRECER": 7, "Sin categor√≠a": 2, "SEGURIDAD": 1, "TRANSPARENCIA P√öBLICA": 1}, "Secretar√≠a del Deporte y la Recreaci√≥n": {"Sin categor√≠a": 109, "INVERTIR PARA CRECER": 1}, "Secretar√≠a para la Gesti√≥n del Riesgo de Emergencias y Desastres": {"SEGURIDAD": 7, "INVERTIR PARA CRECER": 4, "Sin categor√≠a": 2, "TRANSPARENCIA P√öBLICA": 2}, "Tecnolog√≠as de la Informaci√≥n y las Comunicaciones de Cali": {"INVERTIR PARA CRECER": 4, "Sin categor√≠a": 4, "TRANSPARENCIA P√öBLICA": 1}, "Unidad Administrativa Especial de Gesti√≥n de Bienes y Servicios de Cali": {"Sin categor√≠a": 8, "TRANSPARENCIA P√öBLICA": 4, "INVERTIR PARA CRECER": 3, "SEGURIDAD": 3}, "Unidad Administrativa Especial de Protecci√≥n Animal Cali": {"Sin categor√≠a": 10, "SEGURIDAD": 2}, "Unidad Administrativa Especial de Servicios P√∫blicos Municipales Uaespm": {"Sin categor√≠a": 18, "SEGURIDAD": 5, "INVERTIR PARA CRECER": 3}, "Yawa": {"Sin categor√≠a": 4}}}, "Instagram": {"global": {"labels": ["Sin categor√≠a", "SEGURIDAD", "INVERTIR PARA CRECER", "TRANSPARENCIA P√öBLICA", "Error en procesamiento"], "values": [405, 125, 76, 30, 1]}, "perfiles": ["alcaldiadecali", "alejoeder", "bienesyservicioscali", "calibienestar", "caliculturacol", "calivivienda", "casamatriacali", "dagmaoficial", "educacioncali", "festsalsacali", "gobiernocali", "hacienda.cali", "infraestructuracali", "movilidadcali", "participacionciudadanacali", "petronioco", "planeacioncali", "proteccionanimalcali", "riesgocali", "secdeportecali", "secpazycccali", "secsaludcali", "secturismocali", "seguridadcali", "ticalcaldiacali", "uaespcali", "yawacali"], "data_por_perfil": {"alcaldiadecali": {"labels": ["Sin categor√≠a", "INVERTIR PARA CRECER", "SEGURIDAD", "TRANSPARENCIA P√öBLICA"], "values": [27, 9, 7, 2]}, "alejoeder": {"labels": ["Sin categor√≠a", "SEGURIDAD", "INVERTIR PARA CRECER", "TRANSPARENCIA P√öBLICA"], "values": [19, 12, 8, 1]}, "bienesyservicioscali": {"labels": ["Sin categor√≠a", "INVERTIR PARA CRECER", "SEGURIDAD", "TRANSPARENCIA P√öBLICA"], "values": [5, 3, 3, 3]}, "calibienestar": {"labels": ["Sin categor√≠a", "SEGURIDAD", "INVERTIR PARA CRECER", "TRANSPARENCIA P√öBLICA"], "values": [32, 3, 2, 2]}, "caliculturacol": {"labels": ["Sin categor√≠a", "INVERTIR PARA CRECER", "SEGURIDAD"], "values": [12, 1, 1]}, "calivivienda": {"labels": ["INVERTIR PARA CRECER", "Sin categor√≠a", "SEGURIDAD", "TRANSPARENCIA P√öBLICA"], "values": [13, 4, 2, 1]}, "casamatriacali": {"labels": ["Sin categor√≠a", "INVERTIR PARA CRECER"], "values": [3, 1]}, "dagmaoficial": {"labels": ["Sin categor√≠a", "INVERTIR PARA CRECER"], "values": [10, 1]}, "educacioncali": {"labels": ["Sin categor√≠a", "INVERTIR PARA CRECER", "TRANSPARENCIA P√öBLICA"], "values": [12, 9, 2]}, "festsalsacali": {"labels": ["Sin categor√≠a"], "values": [1]}, "gobiernocali": {"labels": ["INVERTIR PARA CRECER", "Sin categor√≠a", "TRANSPARENCIA P√öBLICA", "SEGURIDAD"], "values": [3, 3, 3, 1]}, "hacienda.cali": {"labels": ["Sin categor√≠a"], "values": [4]}, "infraestructuracali": {"labels": ["INVERTIR PARA CRECER", "TRANSPARENCIA P√öBLICA", "SEGURIDAD", "Sin categor√≠a"], "values": [11, 2, 1, 1]}, "movilidadcali": {"labels": ["SEGURIDAD", "Sin categor√≠a", "INVERTIR PARA CRECER"], "values": [45, 4, 1]}, "participacionciudadanacali": {"labels": ["Sin categor√≠a", "TRANSPARENCIA P√öBLICA", "INVERTIR PARA CRECER", "Error en procesamiento", "SEGURIDAD"], "values": [22, 6, 3, 1, 1]}, "petronioco": {"labels": ["Sin categor√≠a"], "values": [19]}, "planeacioncali": {"labels": ["Sin categor√≠a", "TRANSPARENCIA P√öBLICA", "SEGURIDAD"], "values": [7, 2, 1]}, "proteccionanimalcali": {"labels": ["Sin categor√≠a", "SEGURIDAD"], "values": [9, 2]}, "riesgocali": {"labels": ["SEGURIDAD", "INVERTIR PARA CRECER", "Sin categor√≠a", "TRANSPARENCIA P√öBLICA"], "values": [8, 3, 3, 2]}, "secdeportecali": {"labels": ["Sin categor√≠a", "INVERTIR PARA CRECER"], "values": [145, 1]}, "secpazycccali": {"labels": ["SEGURIDAD", "Sin categor√≠a", "TRANSPARENCIA P√öBLICA"], "values": [11, 8, 2]}, "secsaludcali": {"labels": ["Sin categor√≠a", "SEGURIDAD"], "values": [16, 3]}, "secturismocali": {"labels": ["Sin categor√≠a"], "values": [16]}, "seguridadcali": {"labels": ["SEGURIDAD", "INVERTIR PARA CRECER", "Sin categor√≠a"], "values": [20, 2, 2]}, "ticalcaldiacali": {"labels": ["Sin categor√≠a", "INVERTIR PARA CRECER", "TRANSPARENCIA P√öBLICA"], "values": [4, 3, 2]}, "uaespcali": {"labels": ["Sin categor√≠a", "SEGURIDAD", "INVERTIR PARA CRECER"], "values": [13, 4, 2]}, "yawacali": {"labels": ["Sin categor√≠a"], "values": [4]}}, "profile_cat_table": {"alcaldiadecali": {"Sin categor√≠a": 27, "INVERTIR PARA CRECER": 9, "SEGURIDAD": 7, "TRANSPARENCIA P√öBLICA": 2}, "alejoeder": {"Sin categor√≠a": 19, "SEGURIDAD": 12, "INVERTIR PARA CRECER": 8, "TRANSPARENCIA P√öBLICA": 1}, "bienesyservicioscali": {"Sin categor√≠a": 5, "INVERTIR PARA CRECER": 3, "SEGURIDAD": 3, "TRANSPARENCIA P√öBLICA": 3}, "calibienestar": {"Sin categor√≠a": 32, "SEGURIDAD": 3, "INVERTIR PARA CRECER": 2, "TRANSPARENCIA P√öBLICA": 2}, "caliculturacol": {"Sin categor√≠a": 12, "INVERTIR PARA CRECER": 1, "SEGURIDAD": 1}, "calivivienda": {"INVERTIR PARA CRECER": 13, "Sin categor√≠a": 4, "SEGURIDAD": 2, "TRANSPARENCIA P√öBLICA": 1}, "casamatriacali": {"Sin categor√≠a": 3, "INVERTIR PARA CRECER": 1}, "dagmaoficial": {"Sin categor√≠a": 10, "INVERTIR PARA CRECER": 1}, "educacioncali": {"Sin categor√≠a": 12, "INVERTIR PARA CRECER": 9, "TRANSPARENCIA P√öBLICA": 2}, "festsalsacali": {"Sin categor√≠a": 1}, "gobiernocali": {"INVERTIR PARA CRECER": 3, "Sin categor√≠a": 3, "TRANSPARENCIA P√öBLICA": 3, "SEGURIDAD": 1}, "hacienda.cali": {"Sin categor√≠a": 4}, "infraestructuracali": {"INVERTIR PARA CRECER": 11, "TRANSPARENCIA P√öBLICA": 2, "SEGURIDAD": 1, "Sin categor√≠a": 1}, "movilidadcali": {"SEGURIDAD": 45, "Sin categor√≠a": 4, "INVERTIR PARA CRECER": 1}, "participacionciudadanacali": {"Sin categor√≠a": 22, "TRANSPARENCIA P√öBLICA": 6, "INVERTIR PARA CRECER": 3, "Error en procesamiento": 1, "SEGURIDAD": 1}, "petronioco": {"Sin categor√≠a": 19}, "planeacioncali": {"Sin categor√≠a": 7, "TRANSPARENCIA P√öBLICA": 2, "SEGURIDAD": 1}, "proteccionanimalcali": {"Sin categor√≠a": 9, "SEGURIDAD": 2}, "riesgocali": {"SEGURIDAD": 8, "INVERTIR PARA CRECER": 3, "Sin categor√≠a": 3, "TRANSPARENCIA P√öBLICA": 2}, "secdeportecali": {"Sin categor√≠a": 145, "INVERTIR PARA CRECER": 1}, "secpazycccali": {"SEGURIDAD": 11, "Sin categor√≠a": 8, "TRANSPARENCIA P√öBLICA": 2}, "secsaludcali": {"Sin categor√≠a": 16, "SEGURIDAD": 3}, "secturismocali": {"Sin categor√≠a": 16}, "seguridadcali": {"SEGURIDAD": 20, "INVERTIR PARA CRECER": 2, "Sin categor√≠a": 2}, "ticalcaldiacali": {"Sin categor√≠a": 4, "INVERTIR PARA CRECER": 3, "TRANSPARENCIA P√öBLICA": 2}, "uaespcali": {"Sin categor√≠a": 13, "SEGURIDAD": 4, "INVERTIR PARA CRECER": 2}, "yawacali": {"Sin categor√≠a": 4}}}};
    const CAT2COLOR = {"Error en procesamiento": "hsl(0 70% 48% / 0.9)", "INVERTIR PARA CRECER": "hsl(90 70% 48% / 0.9)", "SEGURIDAD": "hsl(180 70% 48% / 0.9)", "TRANSPARENCIA P√öBLICA": "hsl(270 70% 48% / 0.9)", "Sin categor√≠a": "hsl(0 0% 70% / 0.9)"};
    const ALL_CATS = ["Error en procesamiento", "INVERTIR PARA CRECER", "SEGURIDAD", "Sin categor√≠a", "TRANSPARENCIA P√öBLICA"];
    Chart.register(ChartDataLabels);

    function colorsFor(labels) { return labels.map(l => CAT2COLOR[l] || "hsl(210 5% 70% / 0.9)"); }

    const modoSel = document.getElementById('modo');
    const redSel = document.getElementById('red');
    const perfilSelWrap = document.getElementById('perfilSelectWrap');
    const perfilSel = document.getElementById('perfil');
    const canvasArea = document.getElementById('canvasArea');
    const mainCanvas = document.getElementById('mainChart');
    const catOrderSel = document.getElementById('catOrder');
    const dirOrderSel = document.getElementById('dirOrder');

    // Toggle comparar
    const compareToggle = document.getElementById('compareToggle');
    const comparePanel = document.getElementById('comparePanel');
    let isComparing = false;

    // Comparar controls
    const redA = document.getElementById('redA');
    const perfilA = document.getElementById('perfilA');
    const redB = document.getElementById('redB');
    const perfilB = document.getElementById('perfilB');

    let mainChart = null;

    function populatePerfiles(selectEl, red) {
      const perfiles = PAYLOAD[red].perfiles;
      selectEl.innerHTML = '';
      perfiles.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p; opt.textContent = p;
        selectEl.appendChild(opt);
      });
    }

    function populateCategoriasOrden() {
      catOrderSel.innerHTML = '';
      ALL_CATS.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c;
        catOrderSel.appendChild(opt);
      });
    }

    function legendPosition() {
      return window.innerWidth < 900 ? 'bottom' : 'right';
    }

    function datalabelsPercentOptions() {
      return {
        formatter: (value, ctx) => {
          const data = ctx.chart.data.datasets[0].data;
          const total = data.reduce((a,b) => a + b, 0);
          const pct = total ? (value / total * 100) : 0;
          return pct.toFixed(1) + '%';
        },
        color: '#111827',
        font: ctx => {
          const w = ctx.chart.width || 300;
          const size = Math.max(9, Math.min(12, Math.round(w / 50)));
          return { weight: '600', size };
        },
        clamp: true
      };
    }

    function makeDoughnut(ctx, labels, values, title) {
      const colors = colorsFor(labels);
      return new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 1, hoverOffset: 6 }] },
        options: {
          cutout: '60%',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: legendPosition() },
            title: { display: !!title, text: title },
            datalabels: datalabelsPercentOptions()
          }
        }
      });
    }

    function clearCharts() {
      const nodes = Array.from(canvasArea.querySelectorAll('canvas'));
      nodes.forEach((c) => {
        const chart = Chart.getChart(c);
        if (chart) chart.destroy();
        if (c.id !== 'mainChart') c.parentElement.remove();
      });
      if (mainChart) { mainChart.destroy(); mainChart = null; }
      mainCanvas.style.display = 'block';
      canvasArea.classList.remove('cols-2','cols-3');
    }

    function renderGlobal() {
      clearCharts();
      const red = redSel.value;
      const g = PAYLOAD[red].global;
      mainChart = makeDoughnut(mainCanvas.getContext('2d'), g.labels, g.values, `Global ¬∑ ${red}`);
    }

    function renderPorPerfil() {
      clearCharts();
      const red = redSel.value;
      const perfil = perfilSel.value || PAYLOAD[red].perfiles[0];
      const d = PAYLOAD[red].data_por_perfil[perfil];
      mainChart = makeDoughnut(mainCanvas.getContext('2d'), d.labels, d.values, `${perfil} ¬∑ ${red}`);
    }

    function sortedPerfilesByCategory(red, category, direction) {
      const table = PAYLOAD[red].profile_cat_table;
      const perfiles = [...PAYLOAD[red].perfiles];
      perfiles.sort((a,b) => {
        const av = table[a]?.[category] ?? 0;
        const bv = table[b]?.[category] ?? 0;
        return direction === 'asc' ? av - bv : bv - av;
      });
      return perfiles;
    }

    function renderMosaico() {
      clearCharts();
      mainCanvas.style.display = 'none';
      canvasArea.classList.add('cols-3');
      const red = redSel.value;
      const category = catOrderSel.value;
      const direction = dirOrderSel.value;
      const perfiles = sortedPerfilesByCategory(red, category, direction);
      perfiles.forEach((perfil) => {
        const wrap = document.createElement('div');
        wrap.className = 'chart-wrap';
        const canv = document.createElement('canvas');
        wrap.appendChild(canv);
        canvasArea.appendChild(wrap);
        const d = PAYLOAD[red].data_por_perfil[perfil];
        makeDoughnut(canv.getContext('2d'), d.labels, d.values, perfil);
      });
    }

    function renderComparar() {
      clearCharts();
      mainCanvas.style.display = 'none';
      canvasArea.classList.add('cols-2');

      const pairs = [
        [redA.value, perfilA.value || PAYLOAD[redA.value].perfiles[0]],
        [redB.value, perfilB.value || PAYLOAD[redB.value].perfiles[0]]
      ];
      pairs.forEach(([r,p]) => {
        const wrap = document.createElement('div');
        wrap.className = 'chart-wrap';
        const canv = document.createElement('canvas');
        wrap.appendChild(canv);
        canvasArea.appendChild(wrap);
        const d = PAYLOAD[r].data_por_perfil[p];
        makeDoughnut(canv.getContext('2d'), d.labels, d.values, `${p} ¬∑ ${r}`);
      });
    }

    function onModoChange() {
      if (isComparing) { renderComparar(); return; }
      const modo = modoSel.value;
      if (modo === 'perfil') {
        perfilSelWrap.style.display = 'block';
        renderPorPerfil();
      } else if (modo === 'global') {
        perfilSelWrap.style.display = 'none';
        renderGlobal();
      } else {
        perfilSelWrap.style.display = 'none';
        renderMosaico();
      }
    }

    // Toggle compare behavior
    compareToggle.addEventListener('click', () => {
      isComparing = !isComparing;
      compareToggle.classList.toggle('active', isComparing);
      comparePanel.classList.toggle('open', isComparing);
      onModoChange();
    });

    // Events
    modoSel.addEventListener('change', onModoChange);
    redSel.addEventListener('change', () => { populatePerfiles(perfilSel, redSel.value); onModoChange(); });
    perfilSel.addEventListener('change', renderPorPerfil);
    catOrderSel.addEventListener('change', () => { if (!isComparing && modoSel.value === 'mosaico') renderMosaico(); });
    dirOrderSel.addEventListener('change', () => { if (!isComparing && modoSel.value === 'mosaico') renderMosaico(); });

    // Comparar events
    function updatePerfilOptions() {
      populatePerfiles(perfilA, redA.value);
      populatePerfiles(perfilB, redB.value);
    }
    redA.addEventListener('change', () => { updatePerfilOptions(); if (isComparing) renderComparar(); });
    redB.addEventListener('change', () => { updatePerfilOptions(); if (isComparing) renderComparar(); });
    perfilA.addEventListener('change', () => { if (isComparing) renderComparar(); });
    perfilB.addEventListener('change', () => { if (isComparing) renderComparar(); });

    // Handle responsive legend on resize (debounced)
    let resizeTimer = null;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => onModoChange(), 120);
    });

    // init
    populatePerfiles(perfilSel, redSel.value);
    populatePerfiles(perfilA, redA.value);
    populatePerfiles(perfilB, redB.value);
    populateCategoriasOrden();
    renderGlobal();
  </script>
</body>
</html>

